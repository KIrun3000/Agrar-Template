---
import Layout from '~/layouts/PageLayout.astro';

import Hero from '~/components/widgets/Hero.astro';
import ListingCard from '~/components/listings/ListingCard.astro';
import { ANGEBOTE } from '~/data/angebote';
import placeholderObj from '~/assets/images/placeholders/placeholder-objekt.jpg';
import {
  mapAngebotToListing,
  formatAreaHa,
  formatPrice,
  computeEuroPerHa,
  getCategoryChip,
  getStatusBadge,
  getCoreChipsByCategory,
} from '~/utils/listings';
import { getActiveBrand } from '~/config/activeBrand';
import SectionRenderer from '~/components/SectionRenderer.astro';
import HighlightsRenderer from '~/components/HighlightsRenderer.astro';
import { normalizeSections } from '~/lib/autofit/normalize';
import { selectVariants } from '~/lib/autofit/rules';
import { getEffectiveSectionsOrder, filterExistingSections } from '~/lib/autofit/legacy';

const { home } = getActiveBrand();
const homeContent = (home ?? {}) as Record<string, any>;
const hero = homeContent.hero ?? {};
const highlights = homeContent.highlights ?? {};
const sections = homeContent.sections ?? {};
const sectionsOrder = homeContent.sectionsOrder as string[] | undefined;

// Autofit pipeline: normalize → select variants → determine order → filter existing
const normalizedSections = normalizeSections(sections);
const sectionVariants = selectVariants(normalizedSections);
const effectiveOrder = getEffectiveSectionsOrder(sectionsOrder);
const renderOrder = filterExistingSections(effectiveOrder, sections);

// Variant audit table (when DEBUG_AUTOFIT enabled)
if (import.meta.env.DEBUG_AUTOFIT && String(import.meta.env.DEBUG_AUTOFIT) === 'true') {
  console.log('\n[Autofit] Variant Selection Audit:');
  console.log('┌─────────────┬──────────┬─────────────────────────────────────┬─────────┬───────┬───────┐');
  console.log('│ Section     │ Variant  │ Reason                              │ Missing │ Items │ Media │');
  console.log('├─────────────┼──────────┼─────────────────────────────────────┼─────────┼───────┼───────┤');

  for (const [key, rule] of sectionVariants.entries()) {
    const section = normalizedSections.get(key);
    const missing = section?.meta.missingRequired.join(', ') || '—';
    const items = String(section?.meta.itemsCount ?? 0);
    const media = section?.meta.hasMedia ? 'Yes' : 'No';

    console.log(
      `│ ${key.padEnd(11)} │ ${rule.variant.padEnd(8)} │ ${rule.reason.padEnd(35).slice(0, 35)} │ ${missing.padEnd(7).slice(0, 7)} │ ${items.padEnd(5)} │ ${media.padEnd(5)} │`
    );
  }

  console.log('└─────────────┴──────────┴─────────────────────────────────────┴─────────┴───────┴───────┘\n');
}

const metadata = (homeContent.metadata ?? {
  title: 'Muster Agrarimmobilien – Agrar- und Forstimmobilien',
  description:
    'Diskrete Vermarktung von Ackerland, Grünland, Wald und Agrarbetrieben in Deutschland und der EU. Seit über 15 Jahren Ihr Partner für professionelle Vermittlung.',
  ignoreTitleTemplate: true,
}) as Record<string, unknown>;

const normalizeHighlightListing = (item: Record<string, any>, index: number, placeholderImage: string) => {
  const fallbackId = `highlight-${index + 1}`;
  return {
    id: item.id ?? fallbackId,
    slug: item.slug ?? item.id ?? fallbackId,
    href: item.href,
    title: item.title ?? item.beschreibungKurz ?? 'Angebot',
    status: item.status ?? 'Neu',
    bundesland: item.bundesland ?? '',
    region: item.region ?? item.regionKurz ?? '',
    category: item.category ?? 'acker',
    typeLabel: item.typeLabel ?? item.typ ?? '',
    areaHa: item.areaHa ?? item.flaecheGesamtHa ?? 0,
    image: item.image ?? placeholderImage,
    imageAlt: item.imageAlt ?? item.title ?? item.beschreibungKurz ?? 'Angebot',
    priceText: item.priceText ?? item.kaufpreisText,
    priceValue: item.priceValue ?? item.kaufpreis ?? null,
    priceKind: item.priceKind,
    ackerzahl: item.ackerzahl ?? item.bodenpunkteKern,
    gruenlandzahl: item.gruenlandzahl,
    baumarten: item.baumarten,
    jagdRahmen: item.jagdRahmen,
    jagdpachtBis: item.jagdpachtBis ?? item.pachtBis,
    wasserflaecheHa: item.wasserflaecheHa,
    wasserrecht: item.wasserrecht,
    kultur: item.kultur,
    bewaesserung: item.bewaesserung,
    naturschutzStatus: item.naturschutzStatus,
    schutzFlags: item.schutzFlags,
    mixLabel: item.mixLabel,
  };
};

const heroActions =
  Array.isArray(hero.actions) && hero.actions.length > 0
    ? hero.actions
    : [
        { variant: 'primary', text: 'Kaufen', href: '/angebote' },
        { variant: 'secondary', text: 'Verkaufen', href: '/#kontakt' },
      ];
const heroTitle =
  hero.title ?? 'Agrar- und Forstimmobilien – Ihr spezialisierter Makler für große Flächen';
const heroSubtitle =
  hero.subtitle ??
  'Diskrete Vermarktung von Ackerland, Grünland, Wald und Agrarbetrieben in Deutschland und der EU. Seit über 15 Jahren Ihr Partner für professionelle Vermittlung.';
const heroOverlayLight = hero?.overlay?.light ?? 'from-page/40 via-page/20 to-page/5';
const heroOverlayDark = hero?.overlay?.dark ?? 'from-page/70 via-page/50 to-page/90';
const heroVideo = hero?.video;
const heroBg =
  heroVideo && Array.isArray(heroVideo.sources) && heroVideo.sources.length
    ? `<div class="absolute inset-0">
        <video class="w-full h-full object-cover" autoplay muted loop playsinline ${
          heroVideo.poster ? `poster="${heroVideo.poster}"` : ''
        }>
          ${heroVideo.sources
            .map((source) => `<source src="${source.src}" type="${source.type}" />`)
            .join('')}
        </video>
        <div class="absolute inset-0 bg-gradient-to-b ${heroOverlayLight} dark:${heroOverlayDark}"></div>
      </div>`
    : '';

const highlightEyebrow = highlights.eyebrow ?? 'Aktuelle Highlights';
const highlightTitle = highlights.title ?? 'Aktuelle Highlights';
const highlightSubtitle =
  highlights.subtitle ??
  'Ausgewählte Angebote aus unserem Portfolio. Viele weitere Objekte vermarkten wir diskret außerhalb dieser Website – sprechen Sie uns auf Ihre Wünsche an.';
const highlightCta = highlights.cta ?? { label: 'Alle Angebote anzeigen', href: '/angebote' };
const highlightPageSizeDefault = Number(highlights.pageSize) || 4;
const highlightSource = highlights.source ?? 'angebote';
const highlightCustomItems = Array.isArray(highlights.items) ? highlights.items : [];
---

<Layout metadata={metadata}>
  <Hero id={hero.id ?? 'start'} actions={heroActions} bg={heroBg}>
    <Fragment slot="title">{heroTitle}</Fragment>
    <Fragment slot="subtitle">{heroSubtitle}</Fragment>
  </Hero>

  {
    /* Highlights section - now using HighlightsRenderer with variant autofit */
    (() => {
      const placeholderImage = placeholderObj.src;
      const highlightListings =
        highlightSource === 'custom' && highlightCustomItems.length > 0
          ? highlightCustomItems.map((item, index) => normalizeHighlightListing(item, index, placeholderImage))
          : ANGEBOTE.filter((a) => a.status === 'Neu').map((angebot) => mapAngebotToListing(angebot, placeholderImage));

      return <HighlightsRenderer config={highlights} listings={highlightListings} debug={false} />;
    })()
  }

  {/* Dynamic section rendering via autofit layer */}
  {renderOrder.map((sectionKey) => {
    const section = normalizedSections.get(sectionKey);
    const variantRule = sectionVariants.get(sectionKey);

    // Skip hidden sections or missing mappings
    if (!section || !variantRule || variantRule.variant === 'hidden') {
      return null;
    }

    return (
      <SectionRenderer
        section={section}
        variant={variantRule.variant}
        debug={false}
      />
    );
  })}
</Layout>
