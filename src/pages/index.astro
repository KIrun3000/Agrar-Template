---
import Layout from '~/layouts/PageLayout.astro';

import Hero from '~/components/widgets/Hero.astro';
import Content from '~/components/widgets/Content.astro';
import Stats from '~/components/widgets/Stats.astro';
import Features2 from '~/components/widgets/Features2.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Contact from '~/components/widgets/Contact.astro';
import ListingCard from '~/components/listings/ListingCard.astro';
import { ANGEBOTE } from '~/data/angebote';
import placeholderObj from '~/assets/images/placeholders/placeholder-objekt.jpg';
import sellerImg from '~/assets/images/stock/stock_fuer-verkaeufer.webp';
import investorImg from '~/assets/images/stock/stock_fuer-investoren.webp';
import teamImg from '~/assets/images/stock/stock_ueber-uns.webp';
import {
  mapAngebotToListing,
  formatAreaHa,
  formatPrice,
  computeEuroPerHa,
  getCategoryChip,
  getStatusBadge,
  getCoreChipsByCategory,
} from '~/utils/listings';

const kontaktInfo = {
  firma: 'Muster Agrarimmobilien',
  ansprechpartner: 'Luca Ingenbleek',
  antwortzeit: '< 48h',
};

const metadata = {
  title: 'Muster Agrarimmobilien – Agrar- und Forstimmobilien',
  description:
    'Diskrete Vermarktung von Ackerland, Grünland, Wald und Agrarbetrieben in Deutschland und der EU. Seit über 15 Jahren Ihr Partner für professionelle Vermittlung.',
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <Hero
    id="start"
    actions={[
      { variant: 'primary', text: 'Kaufen', href: '/angebote' },
      {
        text: 'Verkaufen',
        href: '/#kontakt',
        class:
          'bg-white text-slate-900 border border-slate-200 hover:bg-slate-50 shadow-sm dark:bg-slate-900 dark:text-white dark:border-slate-700 dark:hover:bg-slate-800',
      },
    ]}
    bg={
      `<div class="absolute inset-0">
        <video
          class="w-full h-full object-cover"
          autoplay
          muted
          loop
          playsinline
          poster="/media/167754-838892766_medium.mp4"
        >
          <source src="/media/167754-838892766_medium.webm" type="video/webm" />
          <source src="/media/167754-838892766_medium.mp4" type="video/mp4" />
        </video>
        <div class="absolute inset-0 bg-gradient-to-b from-white/40 via-white/20 to-white/5 dark:from-black/60 dark:via-black/40 dark:to-black/70"></div>
      </div>`
    }
  >
    <Fragment slot="title">Agrar- und Forstimmobilien – Ihr spezialisierter Makler für große Flächen</Fragment>
    <Fragment slot="subtitle">
      Diskrete Vermarktung von Ackerland, Grünland, Wald und Agrarbetrieben in Deutschland und der EU. Seit über 15
      Jahren Ihr Partner für professionelle Vermittlung.
    </Fragment>
  </Hero>

  <section id="highlights" class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-6xl">
    <div class="mb-8 text-center">
      <p class="text-sm uppercase tracking-wide text-secondary">Aktuelle Highlights</p>
      <h2 class="text-3xl font-bold">Aktuelle Highlights</h2>
      <p class="text-muted mt-2 max-w-2xl mx-auto">
        Ausgewählte Angebote aus unserem Portfolio. Viele weitere Objekte vermarkten wir diskret außerhalb dieser
        Website – sprechen Sie uns auf Ihre Wünsche an.
      </p>
    </div>

    {
      (() => {
        const placeholderImage = placeholderObj.src;
        const highlightOffers = ANGEBOTE.filter((a) => a.status === 'Neu');
        const highlightListings = highlightOffers.map((angebot) => mapAngebotToListing(angebot, placeholderImage));
        const highlightPageSize = 4;
        const highlightPages = Math.ceil(highlightListings.length / highlightPageSize);
        const highlightHasPager = highlightListings.length > highlightPageSize;
        const highlightPayload = JSON.stringify(
          highlightListings.map((listing) => {
            const price = formatPrice(listing);
            const category = getCategoryChip(listing);
            const status = getStatusBadge(listing);
            const euroPerHa = computeEuroPerHa(listing);
            const coreChips = getCoreChipsByCategory(listing);
            const thirdMetric = euroPerHa
              ? { label: '€/ha', value: euroPerHa }
              : coreChips[0]
                ? { label: coreChips[0].label, value: coreChips[0].value }
                : null;
            const chips = euroPerHa ? coreChips : coreChips.slice(1);
            const metrics = [
              { label: 'Fläche', value: formatAreaHa(listing.areaHa) },
              { label: price.label, value: price.value },
            ];
            if (thirdMetric) metrics.push(thirdMetric);

            return {
              id: listing.id,
              title: listing.title,
              status: status.label,
              statusTone: status.tone,
              category: category.label,
              regionLabel: listing.region ? `${listing.bundesland} · ${listing.region}` : listing.bundesland,
              image: listing.image ?? placeholderImage,
              imageAlt: listing.imageAlt ?? listing.title,
              href: `/angebote/${listing.slug}`,
              metrics,
              chips: chips.slice(0, 1),
            };
          })
        ).replace(/</g, '\\u003c');

        return (
          <>
            <div
              id="highlights-grid"
              data-items={highlightPayload}
              data-page-size={highlightPageSize}
              data-total-pages={highlightPages}
              class="grid gap-4 sm:gap-5 grid-cols-1 xs:grid-cols-2 lg:grid-cols-4"
            >
              {highlightListings.slice(0, highlightPageSize).map((listing) => (
                <ListingCard listing={listing} variant="highlight" />
              ))}
            </div>
            {highlightHasPager && (
              <div class="mt-6 flex items-center justify-center gap-3">
                <button
                  type="button"
                  class="btn-secondary py-2 px-4 text-sm disabled:opacity-40 disabled:cursor-not-allowed"
                  data-highlights-prev
                  disabled
                >
                  Zurück
                </button>
                <span class="text-sm text-muted" data-highlights-page>
                  1 / {highlightPages}
                </span>
                <button
                  type="button"
                  class="btn-secondary py-2 px-4 text-sm disabled:opacity-40 disabled:cursor-not-allowed"
                  data-highlights-next
                >
                  Weiter
                </button>
              </div>
            )}
            <div class="mt-8 flex justify-center">
              <a class="btn-secondary" href="/angebote">Alle Angebote anzeigen</a>
            </div>
            {highlightHasPager && (
              <script is:inline>
                const grid = document.getElementById('highlights-grid');
                const prevBtn = document.querySelector('[data-highlights-prev]');
                const nextBtn = document.querySelector('[data-highlights-next]');
                const pageLabel = document.querySelector('[data-highlights-page]');

                if (grid) {
                  const items = JSON.parse(grid.dataset.items || '[]');
                  const pageSize = parseInt(grid.dataset.pageSize || '4', 10);
                  const totalPages = Math.ceil(items.length / pageSize);
                  let pageIndex = 0;

                  const statusClass = (tone) =>
                    tone === 'success'
                      ? 'bg-emerald-100 text-emerald-700'
                      : tone === 'warning'
                        ? 'bg-amber-100 text-amber-700'
                        : tone === 'muted'
                          ? 'bg-slate-200 text-slate-600'
                          : 'bg-slate-100 text-slate-700';

                  const renderCard = (item) => {
                    const metricsCols = item.metrics.length === 3 ? 'grid-cols-3' : 'grid-cols-2';
                    const titleClamp =
                      'display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;';
                    const regionClamp =
                      'display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;';
                    const metricsHtml = item.metrics
                      .map(
                        (metric) => `
                          <div class=\"flex flex-col\">
                            <span class=\"uppercase tracking-wide\">${metric.label}</span>
                            <span class=\"text-sm font-semibold text-emerald-950 dark:text-white\">${metric.value}</span>
                          </div>`
                      )
                      .join('');
                    const chipsHtml =
                      item.chips && item.chips.length
                        ? `
                          <div class=\"flex flex-wrap gap-2\">
                            ${item.chips
                              .map(
                                (chip) => `
                                  <span class=\"inline-flex items-center rounded-full border border-emerald-100 bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-800 dark:border-emerald-900/40 dark:bg-emerald-900/20 dark:text-emerald-200\">
                                    ${chip.label}: ${chip.value}
                                  </span>`
                              )
                              .join('')}
                          </div>`
                        : '';
                    return `
                      <article class="group relative flex h-full flex-col overflow-hidden rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-slate-900 shadow-sm transition-transform duration-150 hover:-translate-y-1">
                        <a href="${item.href}" class="absolute inset-0 z-10" aria-label="${item.title} – Details ansehen" tabindex="-1"></a>
                        <div class="relative z-20 flex h-full flex-col">
                          <div class="relative overflow-hidden rounded-xl">
                            <div class="pt-[56.25%]"></div>
                            <img src="${item.image}" alt="${item.imageAlt}" class="absolute inset-0 h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]" loading="lazy" width="1280" height="720" />
                            <span class="absolute left-3 top-3 inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${statusClass(item.statusTone)}">${item.status}</span>
                            <span class="absolute right-3 top-3 inline-flex items-center rounded-full bg-white/90 px-2.5 py-1 text-xs font-semibold text-slate-700 shadow-sm backdrop-blur dark:bg-slate-900/80 dark:text-slate-200">${item.category}</span>
                          </div>
                          <div class="flex flex-1 flex-col gap-3 px-1 pb-4 pt-4">
                            <h3 class="text-base font-semibold leading-tight text-emerald-950 dark:text-white" style="${titleClamp}">${item.title}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400" style="${regionClamp}">${item.regionLabel}</p>
                            <div class="grid ${metricsCols} gap-3 text-xs text-slate-500 dark:text-slate-400">
                              ${metricsHtml}
                            </div>
                            ${chipsHtml}
                            <div class="mt-auto flex flex-col gap-2 sm:flex-row">
                              <a href="${item.href}" class="btn-primary h-11 w-full text-sm sm:w-auto">Details ansehen</a>
                            </div>
                          </div>
                        </div>
                      </article>`;
                  };

                  const render = () => {
                    const start = pageIndex * pageSize;
                    const pageItems = items.slice(start, start + pageSize);
                    grid.innerHTML = pageItems.map(renderCard).join('');
                    if (pageLabel) pageLabel.textContent = `${pageIndex + 1} / ${totalPages}`;
                    if (prevBtn) prevBtn.disabled = pageIndex === 0;
                    if (nextBtn) nextBtn.disabled = pageIndex >= totalPages - 1;
                  };

                  if (prevBtn) prevBtn.addEventListener('click', () => {
                    if (pageIndex > 0) {
                      pageIndex -= 1;
                      render();
                    }
                  });

                  if (nextBtn) nextBtn.addEventListener('click', () => {
                    if (pageIndex < totalPages - 1) {
                      pageIndex += 1;
                      render();
                    }
                  });

                  render();
                }
              </script>
            )}
          </>
        );
      })()
    }
  </section>

  <Content
    id="verkaeufer"
    tagline="Service"
    title="Für Verkäufer"
    subtitle="Sie planen den Verkauf von Ackerland, Grünland, Wald oder eines gesamten Agrarbetriebs? Wir begleiten Sie diskret und strukturiert durch den gesamten Prozess – von der ersten Bewertung bis zum Notartermin."
    items={[
      {
        title: 'Unsere Leistungen',
        description:
          '• Marktgerechte Bewertung auf Basis von Bodenpunkten, Pachtstrukturen und regionaler Nachfrage\n• Diskrete Vermarktung über unser Investoren- und Käufernetzwerk, oft ohne öffentliche Ausschreibung\n• Strukturierte Käuferauswahl und professionelle Begleitung bis zum Abschluss\n• Erfahrung mit Betriebsnachfolgen, Vermögensstrukturierung und Verkauf arrondierter Großflächen\n\nGerne geben wir Ihnen eine erste, unverbindliche Einschätzung Ihrer Fläche.',
      },
    ]}
    image={{ src: sellerImg, alt: '[BILD_VERKAEUFER]', width: sellerImg.width, height: sellerImg.height }}
  />

  <Content
    id="investoren"
    isReversed
    tagline="Investment"
    title="Für Investoren"
    subtitle="Sie suchen nach langfristigen Investments in Agrarflächen, Wald oder Agrarbetriebe? Wir vermitteln Objekte im In- und Ausland – von mittelgroßen Flächen in Deutschland bis zu Großbetrieben mit mehreren tausend Hektar."
    items={[
      {
        title: 'Investment-Profile',
        description:
          '• Strukturierte Datenräume mit Bodenqualität (BP), Niederschlagsdaten, Pachtverträgen und Ertragsprognosen\n• Objekte mit klaren Renditestrukturen – viele langfristig verpachtet mit Pachtrenditen von 2,5-3,5%\n• Zugang zu Off-Market-Beständen, die nicht öffentlich ausgeschrieben werden\n• Spezialisierung auf Family Offices, institutionelle Investoren und vermögende Privatanleger\n\nHinterlegen Sie Ihr Suchprofil – wir informieren Sie frühzeitig über passende Angebote.',
      },
    ]}
    image={{ src: investorImg, alt: '[BILD_INVESTOREN]', width: investorImg.width, height: investorImg.height }}
  />

  <Stats
    id="trust"
    stats={[
      { title: 'Hektar vermittelt (letzte 3 Jahre)', amount: '2.500+' },
      { title: 'Jahre Markterfahrung', amount: '15' },
      { title: 'Länder & Regionen', amount: '8' },
      { title: 'Durchschnittliche Antwortzeit', amount: '< 48h' },
    ]}
  />

  <Features2
    id="regionen"
    tagline="Regionen & Länder"
    title="Regionen & Länder"
    subtitle="Wir vermitteln Agrarflächen und Betriebe in ausgewählten Regionen Deutschlands und der EU mit Fokus auf Nord- und Ostdeutschland sowie Osteuropa."
    columns={3}
    items={[
      {
        title: 'Brandenburg',
        description: 'Arrondierte Flächen, Gutshöfe, Wald- und Jagdimmobilien, Berlin-nah',
        icon: 'flat-color-icons:approval',
      },
      {
        title: 'Mecklenburg-Vorpommern',
        description: 'Große Ackerflächen ab 50 ha, strukturstarke Betriebe, BP 40-70',
        icon: 'flat-color-icons:gallery',
      },
      {
        title: 'Sachsen-Anhalt',
        description: 'Hochwertige Schwarzerdeböden, BP 60-90, Hochertragsstandorte',
        icon: 'flat-color-icons:document',
      },
    ]}
  />

  <Features2
    id="leistungen"
    tagline="Leistungen"
    title="Unsere Leistungen"
    subtitle="Wir begleiten Transaktionen diskret und strukturiert – von der ersten Bewertung bis zum erfolgreichen Abschluss."
    columns={3}
    items={[
      {
        title: 'Verkauf',
        description: 'Diskrete Vermarktung, Käuferqualifizierung und Begleitung bis zum Notartermin.',
        icon: 'flat-color-icons:advertising',
        callToAction: { text: 'Kontakt aufnehmen', href: '/?utm_source=leistungen#kontakt' },
      },
      {
        title: 'Bewertung',
        description: 'Bodenpunkte, Pacht, Standortfaktoren und Marktpreise im fundierten Vergleich.',
        icon: 'flat-color-icons:currency-exchange',
        callToAction: { text: 'Kontakt aufnehmen', href: '/?utm_source=leistungen#kontakt' },
      },
      {
        title: 'Beratung',
        description: 'Strukturierung, Nachfolge und Portfolio-Strategie für Eigentümer und Investoren.',
        icon: 'flat-color-icons:business-contact',
        callToAction: { text: 'Kontakt aufnehmen', href: '/?utm_source=leistungen#kontakt' },
      },
    ]}
  />

  <Content
    id="ueber-uns"
    tagline="Unternehmen"
    title="Über uns"
    subtitle="Unser Kernteam vereint Agraringenieure, Forstsachverständige und Transaktionsspezialisten. Wir arbeiten deutschlandweit mit regionalen Partnern und liefern belastbare Entscheidungsgrundlagen – von der ersten Standortanalyse bis zum Notartermin."
    items={[
      {
        title: 'Team, Historie & Philosophie',
        description:
          '2008 gegründet als familiengeführtes Agrar-Beratungsbüro, begleiten wir heute Eigentümer, Family Offices und institutionelle Investoren in Deutschland und der EU. Wir glauben an: \n• Diskretion vor Reichweite – Off-Market, wenn es sinnvoll ist\n• Fundierte Bewertung: Bodenpunkte, Pachtstrukturen, Wasserrechte, Forstinventur\n• Partnerschaft auf Augenhöhe – klare Entscheidungsgrundlagen statt Hochglanzversprechen\n• Nachhaltige Nutzung: Ausgleichsflächen, Waldumbau, Bewässerung & Bodenschutz',
      },
    ]}
    image={{ src: teamImg, alt: 'Team Muster Agrarimmobilien', width: teamImg.width, height: teamImg.height }}
  />

  <CallToAction
    id="cta"
    actions={[
      { variant: 'primary', text: 'Mehr erfahren', href: '/#ueber-uns' },
      { text: 'Kontakt aufnehmen', href: '/#kontakt' },
    ]}
  >
    <Fragment slot="title">Interesse geweckt?</Fragment>
    <Fragment slot="subtitle">
      Kontaktieren Sie uns für ein unverbindliches Erstgespräch oder fordern Sie weitere Informationen zu unseren
      aktuellen Angeboten an.
    </Fragment>
  </CallToAction>

  <Contact
    id="kontakt"
    tagline="Kontakt aufnehmen"
    title="Kontakt aufnehmen"
    subtitle="Sie haben Fragen zu einem Objekt oder möchten eine Ersteinschätzung für Ihre Fläche? Kontaktieren Sie uns – wir melden uns innerhalb von 48 Stunden."
    inputs={[
      { label: 'Name', name: 'name', type: 'text', placeholder: '[NAME]' },
      { label: 'E-Mail', name: 'email', type: 'email', placeholder: '[EMAIL]', autocomplete: 'email' },
      { label: 'Telefon', name: 'phone', type: 'tel', placeholder: '[TELEFON_OPTIONAL]' },
      { label: 'Projektbezug', name: 'projekt', type: 'text', placeholder: '[PROJEKTBEZUG_DROPDOWN]' },
    ]}
    textarea={{ label: 'Nachricht', name: 'message', placeholder: '[NACHRICHT]' }}
    button="Anfrage senden"
  >
    <Fragment slot="info">
      <div class="space-y-4">
        <p class="text-sm uppercase tracking-wide text-secondary">Kontaktinfos</p>
        <h3 class="text-xl font-semibold">{kontaktInfo.firma}</h3>
        <dl class="space-y-2 text-sm">
          <div class="flex items-center justify-between">
            <dt class="text-muted">Ansprechpartner</dt>
            <dd class="font-medium">{kontaktInfo.ansprechpartner}</dd>
          </div>
          <div class="flex items-center justify-between">
            <dt class="text-muted">Antwortzeit</dt>
            <dd class="font-medium">{kontaktInfo.antwortzeit}</dd>
          </div>
        </dl>
        <p class="text-xs text-muted">Kontaktaufnahme ausschließlich über das Formular.</p>
      </div>
    </Fragment>
  </Contact>
</Layout>
