---
import {
  formatAreaHa,
  formatPrice,
  computeEuroPerHa,
  getCategoryChip,
  getStatusBadge,
  getCoreChipsByCategory,
} from '~/utils/listings';
import type { ListingCardProps } from '~/utils/listings';

const {
  listing,
  variant = 'data',
  secondaryCtaHref,
  secondaryCtaLabel = 'Exposé anfordern',
  showSecondaryCta = false,
} = Astro.props as ListingCardProps;

const status = getStatusBadge(listing);
const category = getCategoryChip(listing);
const price = formatPrice(listing);
const euroPerHa = computeEuroPerHa(listing);
const coreChips = getCoreChipsByCategory(listing);

const thirdMetric = euroPerHa
  ? { label: '€/ha', value: euroPerHa }
  : coreChips[0]
    ? { label: coreChips[0].label, value: coreChips[0].value }
    : null;

const chips = euroPerHa ? coreChips : coreChips.slice(1);
const visibleChips = chips.slice(0, variant === 'highlight' ? 1 : 2);

const metrics = [
  { label: 'Fläche', value: formatAreaHa(listing.areaHa) },
  { label: price.label, value: price.value },
];

if (thirdMetric) metrics.push(thirdMetric);

const metricsCols = metrics.length === 3 ? 'grid-cols-3' : 'grid-cols-2';
const regionLabel = listing.region ? `${listing.bundesland} · ${listing.region}` : listing.bundesland;
const href = listing.href ?? `/angebote/${listing.slug}`;
const imageSrc = listing.image ?? '';
const titleClamp = 'display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;';
const regionClamp = 'display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;';
const titleClass = variant === 'highlight' ? 'text-base' : 'text-lg';
---

<article class="group relative flex h-full flex-col overflow-hidden rounded-2xl border border-card-border bg-card shadow-sm transition-transform duration-150 hover:-translate-y-1">
  <a href={href} class="absolute inset-0 z-10" aria-label={`${listing.title} – Details ansehen`} tabindex="-1"></a>

  <div class="relative z-20 flex h-full flex-col">
    <div class="relative overflow-hidden rounded-xl">
      <div class="pt-[56.25%]"></div>
      <img
        src={imageSrc}
        alt={listing.imageAlt ?? listing.title}
        class="absolute inset-0 h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]"
        loading="lazy"
        width="1280"
        height="720"
      />
      <span
        class={`absolute left-3 top-3 inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${
          status.tone === 'success'
            ? 'bg-success/15 text-success'
            : status.tone === 'warning'
              ? 'bg-warning/15 text-warning'
              : status.tone === 'muted'
                ? 'bg-muted/20 text-muted'
                : 'bg-surface/70 text-default'
        }`}
      >
        {status.label}
      </span>
      <span class="absolute right-3 top-3 inline-flex items-center rounded-full bg-card/85 px-2.5 py-1 text-xs font-semibold text-default shadow-sm backdrop-blur border border-card-border/60">
        {category.label}
      </span>
    </div>

    <div class="flex flex-1 flex-col gap-3 px-1 pb-4 pt-4">
      <h3 class={`${titleClass} font-semibold leading-tight text-heading`} style={titleClamp}>
        {listing.title}
      </h3>
      <p class="text-sm text-muted" style={regionClamp}>
        {regionLabel}
      </p>

      <div class={`grid ${metricsCols} gap-3 text-xs text-muted`}>
        {metrics.map((metric) => (
          <div class="flex flex-col">
            <span class="uppercase tracking-wide">{metric.label}</span>
            <span class="text-sm font-semibold text-heading">{metric.value}</span>
          </div>
        ))}
      </div>

      {visibleChips.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {visibleChips.map((chip) => (
            <span class="inline-flex items-center rounded-full border border-primary/20 bg-primary/10 px-2.5 py-1 text-xs font-medium text-primary">
              {chip.label}: {chip.value}
            </span>
          ))}
        </div>
      )}

      <div class="mt-auto flex flex-col gap-2 sm:flex-row">
        <a href={href} class="btn-primary h-11 w-full text-sm sm:w-auto">
          Details ansehen
        </a>
        {showSecondaryCta && secondaryCtaHref && variant === 'data' && (
          <a href={secondaryCtaHref} class="btn-secondary h-11 w-full text-sm sm:w-auto">
            {secondaryCtaLabel}
          </a>
        )}
      </div>
    </div>
  </div>
</article>
